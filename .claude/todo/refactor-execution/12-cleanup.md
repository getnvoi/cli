# 12 - Cleanup Execution

## Reference
Read from: `/Users/ben/Desktop/nvoi-rb/lib/nvoi/`

## Build

### Zeitwerk Pattern (dev-only dependency)

**Gemfile:**
```ruby
group :development do
  gem "zeitwerk"
end
```

**lib/nvoi.rb:**
```ruby
# frozen_string_literal: true

if defined?(Nvoi::AUTOLOADERS)
  require "zeitwerk"
  Nvoi::AUTOLOADERS << Zeitwerk::Loader.for_gem.tap do |loader|
    loader.ignore("#{__dir__}/nvoi/loader.rb")
    loader.setup
  end
else
  require_relative "nvoi/loader"
end

module Nvoi
  VERSION = "0.1.0"
end
```

**bin/generate_loader** (script to regenerate loader.rb):
```ruby
#!/usr/bin/env ruby
require "zeitwerk"

loader = Zeitwerk::Loader.for_gem(warn_on_extra_files: false)
loader.ignore("#{__dir__}/../lib/nvoi/loader.rb")

requires = []
loader.on_load do |cpath, value, abspath|
  requires << abspath.sub("#{__dir__}/../lib/", "").sub(".rb", "")
end
loader.setup
loader.eager_load

File.write("#{__dir__}/../lib/nvoi/loader.rb", <<~RUBY)
  # frozen_string_literal: true
  # AUTO-GENERATED by bin/generate_loader - do not edit manually

  #{requires.map { |r| "require_relative \"#{r.sub('nvoi/', '')}\"" }.join("\n")}
RUBY

puts "Generated lib/nvoi/loader.rb with #{requires.size} requires"
```

**lib/nvoi/loader.rb** (auto-generated, committed):
```ruby
# frozen_string_literal: true
# AUTO-GENERATED by bin/generate_loader - do not edit manually

require_relative "version"
require_relative "objects/server"
# ... all files in dependency order
```

### Create config files

Create `lib/nvoi/version.rb`:
- From reference

Create `lib/nvoi/config/` (keep config types):
- `types.rb` - Config classes (Application, ServerConfig, etc.) - use `Objects::ServiceSpec`
- Other config files as needed

## Validate

- [ ] `tree lib/nvoi -L 2` matches target structure
- [ ] No old directories: `providers/`, `cloudflare/`, `remote/`, `service/`, `steps/`, `deployer/`, `k8s/`, `database/`, `credentials/`
- [ ] `ruby bin/generate_loader` runs without error
- [ ] `lib/nvoi.rb` loads without error (with and without Zeitwerk)

## Test

```bash
cd /Users/ben/Desktop/nvoi-rb-refactor

# Test with Zeitwerk (dev mode)
NVOI_AUTOLOADERS=1 ruby -e "module Nvoi; AUTOLOADERS = []; end; require './lib/nvoi'; p Nvoi::Objects::Server"

# Test without Zeitwerk (production mode - uses loader.rb)
ruby -e "require './lib/nvoi'; p Nvoi::Objects::Server"

# Full test suite
bundle exec rake test
```

**Full test suite must pass.**

## Commit

```bash
git add -A && git commit -m "Phase 12: Final wiring with Zeitwerk pattern"
```

## Final Verification

```bash
# CLI smoke test
./exe/nvoi --help
./exe/nvoi deploy --help
./exe/nvoi delete --help
./exe/nvoi exec --help
./exe/nvoi credentials --help
./exe/nvoi db --help
```
