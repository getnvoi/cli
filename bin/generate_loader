#!/usr/bin/env ruby
# frozen_string_literal: true

# Generates lib/nvoi/loader.rb with explicit requires in dependency order
# Uses Zeitwerk to determine the correct load order

require "zeitwerk"

lib_path = File.expand_path("../lib", __dir__)
$LOAD_PATH.unshift(lib_path) unless $LOAD_PATH.include?(lib_path)

loader = Zeitwerk::Loader.new
loader.push_dir(lib_path)
loader.ignore("#{lib_path}/nvoi/loader.rb")
loader.ignore("#{lib_path}/nvoi/version.rb")  # VERSION constant, not Version class

# Collect requires in load order
requires = []
loader.on_load do |_cpath, _value, abspath|
  relative = abspath.sub("#{lib_path}/", "").sub(".rb", "")
  requires << relative
end

loader.setup
loader.eager_load

# Generate loader.rb - version first, then rest
loader_content = <<~RUBY
  # frozen_string_literal: true
  # AUTO-GENERATED by bin/generate_loader - do not edit manually
  # Run: ruby bin/generate_loader

  require_relative "version"
  #{requires.map { |r| "require_relative \"#{r.sub('nvoi/', '')}\"" }.join("\n")}
RUBY

File.write("#{lib_path}/nvoi/loader.rb", loader_content)

puts "Generated lib/nvoi/loader.rb with #{requires.size + 1} requires"
